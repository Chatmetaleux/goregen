<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Regenbox</title>
	<style>
		table {
			border-spacing: 15px 3px;
		}
	</style>
	<script type="text/javascript" src="/static/lib/d3.min.js"></script>
	<script>
		var wsError;
		var wsButton = '<button onclick="subscribeSocket();">Reconnect</button>';

		function initSocket(ws) {
			d3.selectAll('.ws').html('Ok');
			ws.onerror = function (e) {
				console.log('websocket error', e);
			};
			ws.onmessage = function (e) {
				var v = JSON.parse(e.data);
				var state = v['State'];

				d3.selectAll('.vState').html(state);
				if (state === 'Connected') {
					d3.selectAll('.vVoltage').html(v['Voltage'] + 'mV');
					d3.selectAll('.vChargeState').html(v['ChargeState'])
				} else {
					d3.selectAll('.vVoltage').html('-');
					d3.selectAll('.vChargeState').html('-')
				}
			};
			ws.onclose = function (e) {
				d3.selectAll('.vState').html('no connection to goregen');
				d3.selectAll('.vChargeState').html('-');
				d3.selectAll('.vVoltage').html('-');
				d3.selectAll('.ws').html(wsButton);
				ws.onclose = null;
				ws.onerror = null;
				ws.onmessage = null;
			}
		}

		function subscribeSocket() {
			var ws = new WebSocket('ws://{{.ListenAddr}}/subscribe/snapshot?poll=1s');
			d3.selectAll('.ws').html('connecting...');
			wsError = setTimeout(function() {
				var err = 'couldn\'t connect to goregen server, is it running?';
				console.warn(err);
				d3.selectAll('.ws').html(err);
				setTimeout(function() {
					d3.selectAll('.ws').html(wsButton);
				}, 5000);
			}, 1500);
			ws.onopen = function () {
				clearInterval(wsError);
				initSocket(ws);
			};
		}
		subscribeSocket();
	</script>
</head>
<body>
	<h1>Hello Regenbox!</h1>
	<hr/>
	<h2>overview</h2>
	<table>
		<tr>
			<td>State:</td>
			<td class="v vState">-</td>
		</tr>
		<tr>
			<td>ChargeState:</td>
			<td class="v vChargeState">-</td>
		</tr>
		<tr>
			<td>Tension</td>
			<td class="v vVoltage">-</td>
		</tr>
		<tr>
			<td>WebSocket:</td>
			<td class="ws">-</td>
		</tr>
	</table>
	<hr>
	<!--
	type Config struct {
		Mode          Mode          // Auto-mode lets the box do charge cycles using the following config values
		NbHalfCycles  int           // In auto-mode: number of half-cycles to do before halting auto-mode (0: no-limit holdem)
		UpDuration    time.Duration // In auto-mode: maximum time for an up-cycle before taking action (?)
		DownDuration  time.Duration // In auto-mode: maximum time for a down-cycle before taking action (?)
		TopVoltage    int           // In auto-mode: target top voltage before switching charge-cycle
		BottomVoltage int           // In auto-mode: target bottom voltage before switching charge-cycle
		IntervalSec   time.Duration // In auto-mode: sleep interval in second between each measure
		ChargeFirst   bool          // In auto-mode: start auto-run with a charge-cycle (false: discharge)
	}
	-->
	<h2>config</h2>
	<table>
		<tr>
			<td>Mode:</td>
			<td class="cfgMode">{{.Config.Mode}}</td>
		</tr>
		<tr>
			<td>Number of half-cycles to do:</td>
			<td class="cfgNbHalfCycles">{{.Config.NbHalfCycles}}</td>
		</tr>
		<tr>
			<td>Maximum charge duration:</td>
			<td class="cfgUpDuration">{{.Config.UpDuration}}</td>
		</tr>
		<tr>
			<td>Maximum discharge duration:</td>
			<td class="cfgDownDuration">{{.Config.DownDuration}}</td>
		</tr>
		<tr>
			<td>Target upper-bond voltage:</td>
			<td class="cfgTopVoltage">{{.Config.TopVoltage}} mV</td>
		</tr>
		<tr>
			<td>Target lower-bond voltage:</td>
			<td class="cfgBottomVoltage">{{.Config.BottomVoltage}} mV</td>
		</tr>
		<tr>
			<td>Snapshots interval duration:</td>
			<td class="cfgIntervalSec">{{.Config.IntervalSec}}</td>
		</tr>
		<tr>
			<td>First cycle is a charge cycle:</td>
			<td class="cfgChargeFirst">{{.Config.ChargeFirst}}</td>
		</tr>
	</table>
</body>
</html>
